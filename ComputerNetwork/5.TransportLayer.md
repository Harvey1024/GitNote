# 5. 运输层
## 5.1 概述
运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，也是用户功能中的最低层。  
运输层功能：
1. 复用multiplexing: 发送方不同进程同时使用一个运输层协议传送数据
2. 分用demultiplexing：接受方在剥去报文的首部后能正确交付数据到目的进程

运输层提供应用程序间的逻辑通信。  
网络层为主机之间提供逻辑通信。  

运输层的两个主要协议：
1. UDP User datagram protocol
2. TCP Transimission control protocol
UDP传输数据前不需要先建立连接，是不可靠传输，效率高。  
TCP提供面向连接的服务，需要建立连接，释放连接，不提供广播或多播服务，是可靠传输。  

端口：
1. 服务器端使用端口号：熟知端口/系统端口0~1023，例如HTTP：80，HTTPS：443，FTP：21，登记端口号1024~49151
2. 客户端使用端口号：49152~65535，客户进程动态选择。

## 5.2 用户数据报协议UDP
UDP特点：
1. 无连接的
2. 尽最大努力交付
3. 面向报文的，应用层报文加上UDP首部传给IP层
4. 没有拥塞控制，
5. 支持一对一，一对多，多对一，多对多的交互通信
6. 首部开销小，8字节，TCP有20字节

UDP首部：
1. 源端口
2. 目的端口
3. 长度
4. 检验和，计算校验和时在数据报前增加伪首部(伪首部不向上或向下传)

![picture 2](img/1602920097668.png)


## 5.3 传输控制协议TCP
TCP特点：
1. 是面向连接的运输层协议
2. 只能是一对一（点对点)的，只能有两个端点
3. 提供可靠交付的服务
4. 提供全双工通信（双方任何时候都可以发送数据，两端设有发送缓存和接受缓存）
5. 面向字节流，TCP将应用层传下来的数据看做是字节流，不知道实际意义。

TCP有两个端点，端点叫做套接字socket, 端口号拼接到IP地址构成套接字。  
socket = (IP地址:端口号)  
TCP连接唯一的被通信两端的两个端点所确定。  
TCP连接::={socket1, socket2} = {(IP1, port1),(IP2, port2)}

## 5.4 可靠传输控制协议
1. 停止等待协议：接收到对方确认再发送下一个分组
2. 连续ARQ协议，automatic repeat request自动重传请求。每接受到一个确认，就把发送窗口向前滑动一个分组的位置。接受方采用累积确认，对按序到达的最后一个分组发送确认。
## 5.5 TCP报文段的首部格式
![picture 1](img/1600090668541.png)  

## 5.6 TCP可靠传输的实现
### 5.6.1 以字节为单位的滑动窗口
发送端A连续发送，接收端接B收到连续的字节后发送给A最大的位置，A的发送窗口向前移动。当B的接受窗口前几个没按序收到，则一直不会给A发送通知，A已经全部发完等待B通知，超时后重传。
![picture 3](img/1602923951559.png)  

## 5.7 TCP的流量控制
## 5.8 TCP的拥塞控制
## 5.9 TCP的运输连接管理

[next chapter](./6.ApplicationLayer.md)